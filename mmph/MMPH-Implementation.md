# Отчет: Monotone Minimal Perfect Hashing (MMPH)

## 1. Обзор проблемы

**Monotone Minimal Perfect Hash Function (MMPH)** — это функция $h$, которая отображает набор из $n$ ключей $S$ в диапазон целых
чисел $[0, n-1]$ так, что сохраняется лексикографический порядок ключей.

Если $key_1 < key_2$, то $h(key_1) < h(key_2)$. По сути, это функция, возвращающая ранг (порядковый номер) ключа в отсортированном множестве
за константное время.

### Текущее состояние в Go

На данный момент в экосистеме Go отсутствуют готовые библиотеки, реализующие алгоритмы сжатия MMPH. Существующие библиотеки (например,
`alecthomas/mph`) реализуют обычное минимальное идеальное хеширование (MPH), которое не сохраняет порядок.

## 2. Теоретические методы (на основе статьи 2009 г.)

Согласно документу [«Monotone Minimal Perfect Hashing»](https://vigna.di.unimi.it/ftp/papers/MonotoneMinimalPerfectHashing.pdf), существуют
два основных теоретических подхода, оптимизирующих потребление памяти. Здесь $n$ — количество ключей, $w$ — длина машинного слова (например,
64 бита).

### Метод А: Bucketing with LCP (Скорость)

Использует сегментирование на основе наибольших общих префиксов.

- **Время запроса**: $O(1)$
- **Память**: $O(n \log w)$ бит
- **Особенность**: Самый быстрый метод из классических, но потребляет больше памяти, чем вариант с Trie

### Метод Б: Probabilistic Trie (Сжатие)

Использует вероятностные деревья (z-fast trie) и относительное ранжирование.

- **Время запроса**: $O(\log w)$ (не зависит от $n$, только от разрядности ключа)
- **Память**: $O(n \log \log w)$ бит
- **Особенность**: Экстремально компактное хранение (теоретически 2-3 бита на ключ), но сложная реализация

## 3. Современные подходы (State-of-the-Art)

### LeMonHash (Learned Monotone Minimal Perfect Hashing)

Современный метод (представлен в 2023 году), использующий концепцию Learned Indexes вместо классических структур данных.

**Принцип работы**: Использует PGM-index (Piecewise Geometric Model) для построения кусочно-линейной функции, аппроксимирующей график
зависимости ключа от его ранга. Коллизии и неточности предсказания разрешаются с помощью вспомогательной структуры BuRR.

**Преимущества**:

- **Компактность**: Достигает потребления памяти 1.3 – 3 бита на ключ, что часто превосходит теоретические методы на основе Trie
- **Скорость**: Благодаря "плоской" структуре (вычисления вместо переходов по указателям) обеспечивает высокую скорость чтения, удобную для
  префетчинга CPU

**Статус**: Существует эталонная реализация на C++ ([GitHub: ByteHamster/LeMonHash](https://github.com/ByteHamster/LeMonHash)). Портов на Go
пока нет.

## 4. Сравнительный анализ асимптотик

Ниже приведено сравнение теоретических методов, современных подходов и стандартного Workaround'а.

| Метод                               | Время запроса (Query)  | Потребление памяти (Space) | Сложность реализации             |
|-------------------------------------|------------------------|----------------------------|----------------------------------|
| Standard MPH + Array (aka baseline) | $O(1)$                 | $O(n \log n)$              | Низкая (существующие библиотеки) |
| MMPH: LCP Bucketing                 | $O(1)$                 | $O(n \log w)$              | Высокая                          |
| MMPH: Relative Trie                 | $O(\log w)$            | $O(n \log \log w)$         | Очень высокая                    |
| LeMonHash (Learned)                 | Быстро (Math + Lookup) | $O(n)$                     | ? Можно адаптировать LeMonHash ? |

**Примечание**: $n$ — кол-во ключей, $w$ — длина ключа в битах (обычно 64).

## Вывод

Методы из статьи (2009) и современные Learned Indexes (2023) обеспечивают колоссальное сжатие памяти (до 10-20 раз) по сравнению со
стандартным подходом. LeMonHash на данный момент является лидером по эффективности, но требует сложной интеграции (CGO).

## Литература

- [Monotone Minimal Perfect Hashing: Searching a Sorted Table with O(1) Accesses](https://vigna.di.unimi.it/ftp/papers/MonotoneMinimalPerfectHashing.pdf) -
  Belazzougui D., Boldi P., Pagh R., Vigna S.
- [LeMonHash: Learned Monotone Minimal Perfect Hashing](https://github.com/ByteHamster/LeMonHash) - GitHub Repository